<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Puzzle Infinity 10K - Lobby Edition</title>
    <style>
        :root { --accent: #00f2ff; --gold: #ffd700; --bg: #020617; }
        body { 
            margin: 0; font-family: sans-serif; overflow: hidden; color: white;
            background: linear-gradient(45deg, #0f172a, #1e1b4b, #312e81, #1e1b4b);
            background-size: 400% 400%; animation: bgAnim 15s ease infinite;
        }
        @keyframes bgAnim { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

        /* Screens */
        #lobby, #game-screen { height: 100vh; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; transition: 0.3s; }
        #game-screen { display: none; background: #020617; }

        /* Sidebar (Level Lobby) */
        #level-sidebar { 
            position: fixed; top: 0; right: -280px; width: 260px; height: 100%; 
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);
            z-index: 1000; transition: 0.4s ease; padding: 20px; border-left: 2px solid var(--accent);
        }
        #level-sidebar.open { right: 0; }
        .lvl-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; overflow-y: auto; height: 85vh; padding-top: 10px; }
        .lvl-node { padding: 15px 5px; background: #1e293b; border-radius: 10px; text-align: center; font-weight: bold; font-size: 14px; border: none; color: white; cursor: pointer; }
        .lvl-unlocked { background: var(--accent); color: black; box-shadow: 0 0 10px var(--accent); }

        /* Top Bar */
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); }
        
        /* Shop Area */
        #shop { flex-grow: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; padding: 10px; margin-top: 10px; background: rgba(0,0,0,0.4); border-radius: 15px; }
        .color-item { height: 60px; border-radius: 12px; position: relative; border: 2px solid transparent; }
        .locked { filter: grayscale(1) brightness(0.4); }
        .price { position: absolute; bottom: 2px; width: 100%; text-align: center; font-size: 9px; color: var(--gold); font-weight: bold; background: rgba(0,0,0,0.5); }

        /* Game Elements */
        #grid { display: grid; gap: 8px; justify-content: center; margin: 20px auto; }
        .tile { border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); transition: 0.1s; }
        #target { width: 60px; height: 60px; margin: 0 auto 15px; border-radius: 12px; border: 4px solid white; }

        .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; }
        .play-btn { background: #10b981; color: white; width: 100%; margin-top: 10px; font-size: 1.1rem; }
    </style>
</head>
<body>

    <!-- LEVEL SIDEBAR (Kone mein Level Lobby) -->
    <div id="level-sidebar">
        <button class="btn" onclick="toggleSidebar()" style="background:#ef4444; width:100%; color:white; margin-bottom:10px;">CLOSE LOBBY</button>
        <div class="lvl-grid" id="sidebar-grid"></div>
    </div>

    <!-- MAIN LOBBY -->
    <div id="lobby">
        <div class="top-bar">
            <button class="btn" onclick="toggleSidebar()" style="background:var(--accent); color:black;">â˜° LEVELS</button>
            <div style="color:var(--gold); font-size: 20px;">ðŸ’° <span id="l-coins">0</span></div>
        </div>
        <p style="text-align:center; font-size:12px; margin:10px 0;">SHOP: Kharidein Colors (Har 15 level par Free!)</p>
        <div id="shop"></div>
        <button class="play-btn btn" onclick="startCurrent()">PLAY CURRENT LEVEL (<span id="l-lvl">1</span>)</button>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen">
        <div class="top-bar">
            <button class="btn" onclick="goToLobby()" style="background:#ef4444; color:white;">EXIT</button>
            <div id="timer" style="font-size:20px; font-weight:bold; color:var(--gold);">40s</div>
        </div>
        <h2 id="g-lvl-title" style="text-align:center; margin:15px 0;">Level 1</h2>
        <div id="target"></div>
        <div id="grid"></div>
    </div>

<script>
    const allColors = [];
    for(let i=0; i<100; i++) allColors.push(`hsl(${(i * 137) % 360}, 70%, 55%)`);

    let coins = parseInt(localStorage.getItem('p_coins_2026')) || 0;
    let unlockedLvl = parseInt(localStorage.getItem('p_lvl_2026')) || 1;
    let owned = JSON.parse(localStorage.getItem('p_owned_2026')) || [allColors[0], allColors[1], allColors[2]];
    let timerId, audioCtx;

    function init() {
        // Auto Unlock system (Har 15 level par)
        let bonusCount = Math.floor(unlockedLvl / 15);
        for(let i=0; i <= bonusCount + 2; i++) {
            if(i < 100 && !owned.includes(allColors[i])) owned.push(allColors[i]);
        }
        
        document.getElementById('l-coins').innerText = coins;
        document.getElementById('l-lvl').innerText = unlockedLvl;
        localStorage.setItem('p_coins_2026', coins);
        localStorage.setItem('p_lvl_2026', unlockedLvl);
        localStorage.setItem('p_owned_2026', JSON.stringify(owned));
        
        loadShop();
        loadSidebarGrid();
    }

    function loadShop() {
        const shopDiv = document.getElementById('shop');
        shopDiv.innerHTML = "";
        allColors.forEach((c, i) => {
            let isOwned = owned.includes(c);
            let price = (i * 200) + 100;
            let item = document.createElement('div');
            item.className = 'color-item' + (isOwned ? '' : ' locked');
            item.style.backgroundColor = c;
            if(!isOwned) item.innerHTML = `<div class="price">ðŸ’°${price}</div>`;
            item.onclick = () => {
                if(!audioCtx) startAudio();
                if(!isOwned && coins >= price) { coins -= price; owned.push(c); init(); }
            };
            shopDiv.appendChild(item);
        });
    }

    function loadSidebarGrid() {
        const grid = document.getElementById('sidebar-grid');
        grid.innerHTML = "";
        // 10,000 Levels optimized view (current + 50)
        let end = Math.min(10000, unlockedLvl + 50);
        for(let i=1; i<=end; i++) {
            let b = document.createElement('button');
            b.className = 'lvl-node' + (i <= unlockedLvl ? ' lvl-unlocked' : '');
            b.innerText = i;
            b.onclick = () => { if(i <= unlockedLvl) { toggleSidebar(); playLevel(i); } };
            grid.appendChild(b);
        }
    }

    function toggleSidebar() { document.getElementById('level-sidebar').classList.toggle('open'); }

    function startAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let osc = audioCtx.createOscillator();
        let gain = audioCtx.createGain();
        osc.type = 'triangle'; osc.frequency.setValueAtTime(110, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.03, audioCtx.currentTime);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start();
        setInterval(() => { osc.frequency.exponentialRampToValueAtTime(Math.random()*30+100, audioCtx.currentTime+0.5); }, 800);
    }

    function startCurrent() { playLevel(unlockedLvl); }

    function playLevel(lvl) {
        if(!audioCtx) startAudio();
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        document.getElementById('g-lvl-title').innerText = "Level " + lvl;
        
        const grid = document.getElementById('grid'); grid.innerHTML = "";
        let size = lvl > 500 ? 6 : (lvl > 100 ? 5 : (lvl > 15 ? 4 : 3));
        let tSize = Math.min(Math.floor((window.innerWidth - 70) / size), 80);
        grid.style.gridTemplateColumns = `repeat(${size}, ${tSize}px)`;
        
        let pool = owned.slice(0, 3 + Math.floor(lvl/50));
        let target = pool[Math.floor(Math.random() * pool.length)];
        document.getElementById('target').style.backgroundColor = target;

        for(let i=0; i<size*size; i++) {
            let t = document.createElement('div');
            t.className = 'tile'; t.style.width = tSize+'px'; t.style.height = tSize+'px';
            let startCol = pool[Math.floor(Math.random()*pool.length)];
            t.style.backgroundColor = startCol; t.dataset.color = startCol;
            t.onclick = function() {
                let idx = pool.indexOf(this.dataset.color);
                let next = pool[(idx + 1) % pool.length];
                this.style.backgroundColor = next; this.dataset.color = next;
                if(Array.from(document.querySelectorAll('.tile')).every(x => x.dataset.color === target)) {
                    clearInterval(timerId); coins += (10+size); 
                    if(lvl === unlockedLvl) unlockedLvl++; init();
                    alert("Victory!"); playLevel(lvl + 1);
                }
            };
            grid.appendChild(t);
        }

        let time = Math.max(10, 45 - Math.floor(lvl/50));
        clearInterval(timerId);
        timerId = setInterval(() => {
            time--; document.getElementById('timer').innerText = time+"s";
            if(time <= 0) { clearInterval(timerId); alert("Time Over!"); goToLobby(); }
        }, 1000);
    }

    function goToLobby() { 
        clearInterval(timerId); 
        document.getElementById('game-screen').style.display = 'none'; 
        document.getElementById('lobby').style.display = 'flex'; 
        init(); 
    }

    init();
</script>
</body>
</html>
